{% extends "base.html" %}
{% block title %}Barber Calendar - Agendamento{% endblock %}

{% block content %}
<main id="agenda-page" data-ano="{{ ano }}" data-mes="{{ mes }}" data-barber-id="{{ barber_id or '' }}" data-shop-phone="{{ barbershop_phone or '' }}">
  <section>
    <h2>{{ barbearia_nome }} - {{ mes_nome }}</h2>
    {% if session.get('role') == 'barbeiro' %}
    <div class="month-selector-container">
      <form method="get" action="{{ url_for('agenda') }}" class="month-selector-form">
        <div class="selector-group">
          <label for="mes">Mês:</label>
          <select id="mes" name="mes" class="styled-select" onchange="this.form.submit()">
            {% for nome_mes in meses_lista %}
              <option value="{{ loop.index }}" {% if loop.index == mes %}selected{% endif %}>{{ nome_mes }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="selector-group">
          <label for="ano">Ano:</label>
          <select id="ano" name="ano" class="styled-select" onchange="this.form.submit()">
              {% for y in range(current_year, current_year + 6) %}
                  <option value="{{ y }}" {% if y == ano %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
          </select>
        </div>
        <!-- Botão "Ir" removido pois onchange já resolve, mas mantemos escondido se precisar de fallback -->
        <noscript><button type="submit" class="btn btn-sm btn-primary">Ir</button></noscript>
      </form>
    </div>
    {% endif %}
    <!-- Mensagem de boas vindas removida conforme solicitado -->

    <div class="calendario-header">
      {% for d in semana_header %}
        <div class="dia-header">{{ d }}</div>
      {% endfor %}
    </div>

    <div class="calendario">
      {% for dia in dias %}
        {% if dia.tipo == 'vazio' %}
          <div class="dia vazio"></div>
        {% else %}
          {% if dia.passado %}
            <div class="dia passado">
                {{ dia.numero }}
            </div>
          {% else %}
            {% if dia.disponivel or session.get('role') == 'barbeiro' %}
            <div class="dia {% if dia.disponivel %}disponivel{% else %}ocupado{% endif %}" data-dia="{{ dia.numero }}">
                {{ dia.numero }}
            </div>
            {% else %}
            <div class="dia ocupado">
                {{ dia.numero }}
            </div>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </section>

  <!-- Modal de horários -->
  <div id="modalHorarios" class="modal">
    <div class="modal-content">
      <span class="fechar">&times;</span>
      <h3>Selecione um horário</h3>
      <ul id="lista-horarios"></ul>
    </div>
  </div>

  <!-- Modal de Sucesso com WhatsApp -->
  <div id="modalSucesso" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h2 style="color: #4caf50;">Agendamento Confirmado!</h2>
      <p style="margin: 1rem 0; color: #666;">Seu horário foi reservado com sucesso.</p>

      <!-- Botão de WhatsApp (inicialmente oculto, exibido via JS se houver telefone) -->
      <a id="btn-whatsapp-confirm" href="#" target="_blank" class="btn-whatsapp-confirm" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
        Confirmar no WhatsApp
      </a>

      <button onclick="window.location.reload()" class="btn-modal-close">
        Fechar
      </button>
    </div>
  </div>

  {% if session.get('role') == 'cliente' %}
  <div class="voltar">
    <a href="{{ url_for('meus_agendamentos') }}" class="btn-voltar">Meus agendamentos</a>
  </div>
  {% endif %}

  {% if session.get('role') != 'barbeiro' %}
  <div style="margin-top: 3rem; text-align: center; font-size: 0.9rem; opacity: 0.7;">
      <a href="{{ url_for('login') }}" style="color: inherit; text-decoration: none;">Sou o barbeiro</a>
  </div>
  {% endif %}
</main>

{% endblock %}
